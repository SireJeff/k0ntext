/**
 * Tool Coordination Module
 * Helpers for adding tool awareness to generated content
 */

const fs = require('fs');
const path = require('path');

/**
 * Get tool coordination header
 * @param {string} toolName - Name of the tool (claude, copilot, cline, antigravity)
 * @param {string} version - Version of create-ai-context
 * @returns {string} Header comment for the tool
 */
function getToolCoordinationHeader(toolName, version) {
  version = version || '2.3.0';

  const newline = '\n';
  const htmlHeaderBase = '<!-- ========================================= -->';
  const htmlFooterBase = '<!-- ========================================= -->';
  const hashHeaderBase = '# ==========================================';
  const hashFooterBase = '# ==========================================';

  const headers = {
    claude: [
      htmlHeaderBase,
      '<!-- WARNING: CLAUDE CODE CONTEXT -->',
      '<!-- Managed by create-ai-context v' + version + ' -->',
      '<!-- Source: .ai-context/ directory -->',
      htmlFooterBase
    ].join(newline),

    copilot: [
      htmlHeaderBase,
      '<!-- WARNING: GITHUB COPILOT INSTRUCTIONS -->',
      '<!-- Managed by create-ai-context v' + version + ' -->',
      '<!-- Source: .ai-context/ directory -->',
      htmlFooterBase
    ].join(newline),

    cline: [
      hashHeaderBase,
      '# WARNING: CLINE RULES',
      '# Managed by create-ai-context v' + version,
      '# Source: .ai-context/ directory',
      hashFooterBase
    ].join(newline),

    antigravity: [
      htmlHeaderBase,
      '<!-- WARNING: ANTIGRAVITY CONTEXT -->',
      '<!-- Managed by create-ai-context v' + version + ' -->',
      '<!-- Source: .ai-context/ directory -->',
      htmlFooterBase
    ].join(newline)
  };

  return headers[toolName] || '';
}

/**
 * Get tool coordination footer
 * @param {string} toolName - Name of the tool
 * @returns {string} Footer content with cross-tool references
 */
function getToolCoordinationFooter(toolName) {
  const footer = '---\n' +
    '## Universal Context Directory\n\n' +
    'This project uses **AI Context Engineering** for coordinated documentation across all AI tools.\n\n' +
    '**Universal Source:** .ai-context/\n\n' +
    '**Related Tool Contexts:**\n' +
    '- Claude Code: `AI_CONTEXT.md`\n' +
    '- GitHub Copilot: `.github/copilot-instructions.md`\n' +
    '- Cline: `.clinerules`\n' +
    '- Antigravity: `.agent/`\n\n' +
    '**Regeneration Command:**\n' +
    '```bash\n' +
    'npx create-ai-context generate --ai ' + toolName + '\n```\n\n' +
    '**To Modify Documentation:**\n' +
    'Edit source files in .ai-context/ then regenerate.\n';

  return footer;
}

/**
 * Check if file is managed by create-ai-context
 * @param {string} filePath - Path to file to check
 * @returns {boolean} True if file is managed by create-ai-context
 */
function isManagedFile(filePath) {
  try {
    if (!fs.existsSync(filePath)) {
      return false;
    }
    const content = fs.readFileSync(filePath, 'utf-8');
    return content.includes('Managed by create-ai-context') ||
           content.includes('CREATE-AI-CONTEXT') ||
           content.includes('Auto-generated by AI Context Engineering');
  } catch {
    return false;
  }
}

/**
 * Get universal context reference for templates
 * @returns {object} Object with context directory info
 */
function getUniversalContextReference() {
  return {
    directory: '.ai-context',
    description: 'Universal AI Context Engineering directory',
    subdirectories: {
      agents: '.ai-context/agents/',
      commands: '.ai-context/commands/',
      context: '.ai-context/context/',
      indexes: '.ai-context/indexes/',
      custom: '.ai-context/custom/',
      tools: '.ai-context/tools/'
    },
    mainFile: 'AI_CONTEXT.md',
    workflowIndex: '.ai-context/context/WORKFLOW_INDEX.md',
    rpiPlan: '.ai-context/RPI_WORKFLOW_PLAN.md'
  };
}

/**
 * Format tool coordination message for CLI output
 * @param {string} toolName - Name of the tool
 * @returns {string} Formatted message
 */
function formatCoordinationMessage(toolName) {
  const messages = {
    claude: 'Claude Code context generated. Symlinks created from .ai-context/',
    copilot: 'Copilot instructions generated from .ai-context/ universal context',
    cline: 'Cline rules generated from .ai-context/ universal context',
    antigravity: 'Antigravity context generated from .ai-context/ universal context'
  };

  return messages[toolName] || toolName + ' context generated';
}

module.exports = {
  getToolCoordinationHeader,
  getToolCoordinationFooter,
  isManagedFile,
  getUniversalContextReference,
  formatCoordinationMessage
};
